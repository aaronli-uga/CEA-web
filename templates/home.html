{% extends 'main.html' %}
{% block content %}

<div class="container">
    <h2 align="center">
        Welcome to the CEA tomatoes growth simulator! 
    </h2>
    <p align="center">
        Our application provides you easy way to simulate the growth of your tomatoes.
    </p>
    <h2>
        Start your simulation
    </h2>
    <p>
        <form action="/" method="POST">
            <div class="col-md-6" >
              <label for="CO2" class="form-label">CO2 (mg/m^2 .s)</label>
              <input type="number" class="form-control" name="CO2" id="CO2" placeholder="234" step="any" required>
            </div>
            <div class="col-md-6">
              <label for="temperature" class="form-label">temperature (Celsius)</label>
              <input type="number" class="form-control" name="temperature" id="temperature" placeholder="23" step="any" required>
            </div>
            <div class="col-md-6">
                <label for="fruit_per_truss" class="form-label">Fruit per truss</label>
                <input type="number" class="form-control" name="fruit_per_truss" id="fruit_per_truss" placeholder="7" required>
            </div>
            <div class="row">
                <div class="form-group col-md-4">
                    <label for="state_name">Select States</label>
                    <select name="state_name" id="state_name" data-live-search="true" title="Select State" required>
                        {%for state_id, state_name in states_info%}
                        <option value={{state_id}}>{{state_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="county_name" class="form-label">Select county</label>
                    <select name="county_name" id="county_name" data-live-search="true" title="Select County" required>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="city_name" class="form-label">Select cities</label>
                    <select name="city_name" id="city_name" data-live-search="true" title="Select Cities" required>
                    </select>
                </div>
            </div>
            <button id="start_button" type="button" name="starbut" class="btn btn-primary">Start Simulation</button>
        </form>
    </p>
    <h2>
        Result:
    </h2>
    <p id="sim_result">
    </p>
</div>

<script>
    $(document).ready(function(){
        $("#state_name").selectpicker();
        $("#county_name").selectpicker();
        $("#city_name").selectpicker();
        
        function load_data(type, category_id){
            console.log({type:type, category_id: category_id})
            $.ajax({
                url: "/city",
                method: "POST",
                data: {type: type, category_id: category_id},
                dataType: "json",
                success: function(data){
                    var html ="";
                    if (type == "cityData"){
                        for (var count = 0; count < data.length; count++){
                            html += '<option value="' + data[count][0]+ '">' + data[count][1] + "</option>";
                        }
                    }   
                    else{
                        for (var count = 0; count < data.length; count++){
                            html += '<option value="' + data[count]+ '">' + data[count] + "</option>";
                        }
                    }
                    if (type == "stateData"){
                        $("#state_name").html(html);
                        $("#state_name").selectpicker("refresh");
                    } else if (type == "countyData"){
                        $("#county_name").html(html);
                        $("#county_name").selectpicker("refresh");
                    } else{
                        $("#city_name").html(html);
                        $("#city_name").selectpicker("refresh");
                    }
                },
            });
        }

        $(document).on("change", "#state_name", function(){
            var category_id = $("#state_name").val();
            load_data("countyData", category_id);
        });

        $(document).on("change", "#county_name", function(){
            var state_id = $("#state_name").val();
            var county_id = $("#county_name").val();
            var city_info = [state_id, county_id];
            console.log(city_info[1])
            load_data("cityData", city_info);
        });

        $("#start_button").click(function(e) {
            console.log("button clicked");
            console.log($("#temperature").val() )
            if (!$('#temperature').val() || !$('#CO2').val() || !$('#fruit_per_truss').val() || !$('#state_name').val() || !$('#county_name').val() || !$('#city_name').val()) {
                alert('Empty value!');
            }
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "/",
                dataType: "json",
                data: { 
                    temperature: $("#temperature").val(),
                    CO2: $("#CO2").val(),
                    fruit_per_truss: $("#fruit_per_truss").val(),
                    city_id: $("#city_name").val()
                },
                success: function(result) {
                    var html="lat:" + result[0][0] + " lon:" + result[0][1];
                    $("#sim_result").html(html);
                },
                error: function(result) {
                    alert('error');
                }
            });
        });
      
    });

</script>

{% endblock %}